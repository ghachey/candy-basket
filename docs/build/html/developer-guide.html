<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Developer Guide &mdash; Candy Basket 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Candy Basket 1.0 documentation" href="index.html" />
    <link rel="prev" title="Administrator Guide" href="administrator-guide.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="administrator-guide.html" title="Administrator Guide"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Candy Basket 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="developer-guide">
<h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This guide documents high level development standards, policies and
procedures without going into lower level details of the source code
and APIs.</p>
<div class="section" id="programming-language">
<h3>Programming Language<a class="headerlink" href="#programming-language" title="Permalink to this headline">¶</a></h3>
<p>The chosen programming language is Javascript both on the backend and
the frontend. Javascript is relatively easy to get started with, it is
increasingly popular to develop web applications and has a growing
wealth of libraries to use to build systems faster. <a class="reference external" href="http://www.nodejs.org/">NodeJS</a> is the Javascript backend platform and a
decent starting point and reference for the Javascript language is
provided by the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">Mozilla Developer Network</a>.</p>
</div>
<div class="section" id="web-stack">
<h3>Web Stack<a class="headerlink" href="#web-stack" title="Permalink to this headline">¶</a></h3>
<p>No web application is built without a web framework (or library). The
prototype was built using Bottle/Flask in Python but the production
system will move to NodeJS and <a class="reference external" href="http://expressjs.com/">ExpressJS</a>. Both are good choices but moving to the
NodeJS has a number of advanges which were important to us including
pervasive use of asynchronous programming on backend and frontend
making it easier to scale with same amount of resources. A road to
unify backend and frontend languages, libraries and devleopment
tooling.</p>
<p>A micro framework was prefered to a full blown and much less flexible
framework such as Django or Ruby on Rails. Applications can be fine
crafted much better with small composable libraries. In addition to
Express, a number of Express plugins are used when needed and
Express middleware pluggins can easily be written when none
appropriate are available.</p>
</div>
<div class="section" id="database">
<h3>Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h3>
<p>The CouchDB document database was chosen for its flexibility and
simplicity. CouchDB is one of the several NoSQL database types built
specifically for the web. If you are not familiar with CouchDB have a
look at its website at <a class="reference external" href="https://couchdb.apache.org/">https://couchdb.apache.org/</a> and documentation at
<a class="reference external" href="http://docs.couchdb.org/en/latest/">http://docs.couchdb.org/en/latest/.</a>.</p>
</div>
</div>
<div class="section" id="setting-up-the-development-environment">
<h2>Setting Up the Development Environment<a class="headerlink" href="#setting-up-the-development-environment" title="Permalink to this headline">¶</a></h2>
<p>It is pretty easy to setup your own development environment to work on
the Candy Basket tool. Here you will find the necessary steps to get
you started. Essentially, the following subsections can be followed in
order and everything should work.</p>
<p>The latest NodeJS will need to be installed on your operating system
(OS); binaries are available for all popular OSes. Instructions are
given in a platform-agnostic fashion to the extent that it is
possible.</p>
<div class="section" id="development-tools">
<h3>Development Tools<a class="headerlink" href="#development-tools" title="Permalink to this headline">¶</a></h3>
<p>You will need you typical development tools: a command line, a text
editor or IDE, a web browser with good development plugins such as the
Google Chrome Javascript console or Firefox&#8217;s web developer extension
and firebug. It does not matter much which tool, choose the ones
you&#8217;re most confortable with.</p>
</div>
<div class="section" id="nodejs-and-npm">
<span id="nodejs-npm"></span><h3>NodeJS and NPM<a class="headerlink" href="#nodejs-and-npm" title="Permalink to this headline">¶</a></h3>
<p>NodeJS is the Javascript platform for writing Javascript software on
the backend. The NodeJS package manager in use is <a class="reference external" href="https://www.npmjs.org/">npm</a> and the canonical way to install npm
package is locally to whatever software you are developing as opposed
to globally on your operating system. Therefore, use:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ npm install express
</pre></div>
</div>
<p>and not:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ npm install -g express
</pre></div>
</div>
<p>There are a couple of exceptions to this. Once you have NodeJS
installed on your machine you should install bower and grunt-cli
globally:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ npm install -b bower
[user]$ npm install -b grunt-cli
</pre></div>
</div>
<p>This is all that should be needed as a foundation development setup.</p>
</div>
<div class="section" id="id1">
<h3>CouchDB<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>CouchDB is used as the database for this tool. The easiest way to
install CouchDB is to use the OS&#8217; package manager (Debian&#8217;s apt-get,
Mac OS X&#8217;s brew, Red Hat&#8217;s yum). CB makes use of three databases:
<cite>candy_basket_test</cite>, <cite>candy_basket_development</cite>, <cite>candy_basket</cite> (for
production). On the development machine only the
candy_basket_development must be created in advanced. The tests will
create and destroy the <cite>candy_basket_test</cite> database automatically, in
fact, tests will fail if this database is already present.</p>
<p>Sample data must be added to the development database. This can be
done in a number of ways, either programmatically importing old
candies or manually entering some sample data using the running
development application. The views have to be created manually at the
moment. You can easily just copy and paste the views definition from
the integration tests (i.e. <cite>backend/test/specs/controllers.js</cite>) in
the CouchDB admin web UI.</p>
<p>In the test database sample data is automatically generated as part of
unit tests and the views are also programmatically created before they
are used.</p>
</div>
<div class="section" id="grunt">
<h3>Grunt<a class="headerlink" href="#grunt" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://gruntjs.com/">Grunt</a> is use to automate a number of time
consuming tasks. It takes a while to learn but is well worth the
efforts. Included here is a short list of things you will use grunt
for.</p>
<div class="section" id="grunt-on-the-backend">
<h4>Grunt on the backend<a class="headerlink" href="#grunt-on-the-backend" title="Permalink to this headline">¶</a></h4>
<p>First, from the <cite>backend</cite> directory you can execute tests and serve
the backend application.</p>
<p>To run the tests from the backend you will need two terminals since
these contain also integration tests in addition to unit tests. In
both terminals you should set the NODE_ENV to &#8216;test&#8217; like this:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ export NODE_ENV=test
</pre></div>
</div>
<p>In one terminal serve the test backend:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt serve
</pre></div>
</div>
<p>And the other terminal you run the tests. Those tests will run against
a test environment (with a test database as configured in
<cite>backend/config.js</cite>):</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt test
</pre></div>
</div>
<p>When simply developing you should only need one terminal to serve the
backend application. But you need to switch the environment to
development wih the following:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ export NODE_ENV=development
</pre></div>
</div>
<p>And then you can server the backend for development with this:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt serve
</pre></div>
</div>
</div>
<div class="section" id="grunt-on-the-frontend">
<h4>Grunt on the frontend<a class="headerlink" href="#grunt-on-the-frontend" title="Permalink to this headline">¶</a></h4>
<p>In the frontend, things are very similar. But currently you can only
switch from development to production environments (the test
environment will work equally in both since they are only unit tests
not dependent on external database and other variants). And not only
that, the switching between production and development environment is
automatic whether you tell grunt to test, serve or deploy. So, all you
reall need in the frontend currently is to run a development web
server:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt serve
</pre></div>
</div>
<p>To run your tests you can:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt test
</pre></div>
</div>
<p>To build the frontend for production (this is only currently available
for frontend where it is more important):</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt
</pre></div>
</div>
<p>The build will first make sure jshint and tests all pass and then do
an impressive number of optimisations to the application and package
it in <cite>frontend/dist</cite>.</p>
</div>
<div class="section" id="grunt-globally-in-app-root">
<h4>Grunt globally in app root<a class="headerlink" href="#grunt-globally-in-app-root" title="Permalink to this headline">¶</a></h4>
<p>Finally, work as also commenced on automating some other tasks in the
root of the candy-basket application. Currently, it only generates a
CHANGELOG.md file automatically and build some Angular documents with
the following commands respectively:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt
[user]$ grunt docs
</pre></div>
</div>
<p>But this grunt section will eventually properly build all
documentation (frontend, backend, user docs), package them for
production builds, runs tests, jshints and build both backend and
frontend in a uniform and fully automated way.</p>
</div>
</div>
<div class="section" id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h3>
<p>This application has a number of dependencies but they can all easily
be installed from within the root of your own clone repository and
from the <cite>backend</cite> and <cite>frontend</cite> directories. The production backend
libraries and the development and test libraries are typically always
npm packages with the dependencies clearly defined the <cite>packages.json</cite>
files, one in the backend, one in the frontend and one in the root
directory. In other words, everywhere you see a package.json file you
must change to that directory and install dependencies like this:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ npm install
</pre></div>
</div>
<p>Frontend dependencies, those that will run in the client browser
powering the web UI are installed using the Bower package management
tool. From within the frontend directory you can simply do:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ bower install
</pre></div>
</div>
<p>Those commands are idempotent and it does not matter how often you
execute them. Installing new dependencies for development can be done
with the same tool.</p>
<p>Backend dependencies and frontend development and test libraries:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ npm install new-grunt-plugin new-backend-library
</pre></div>
</div>
<p>Though to save the dependency in the package.json you would do:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ npm install --save-dev new-grunt-plugin new-backend-library
</pre></div>
</div>
<p>Frontend dependencies:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ bower install new-angular-third-party-directive
</pre></div>
</div>
<p>and the same to persist the dependency if you end up keeping it:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ bower install --save new-angular-third-party-directive
</pre></div>
</div>
<p>Some of the packages may have additional lower level dependencies of
their own in which case you would typically have to install some
package on your OS such as xml headers from the development
package. This should be made clear from failures to install
dependencies and is typically quickly addressed by installing from the
OS&#8217; software repository (apt, yum, brew, etc.)</p>
</div>
</div>
<div class="section" id="development-work-flow">
<h2>Development Work-flow<a class="headerlink" href="#development-work-flow" title="Permalink to this headline">¶</a></h2>
<p>The CB project constantly strives to improve its development
operations in order to produce software of higher quality at a more
efficient rate. This part of the developer guide will constantly
evolve and should be kept close at hand when developing on the CB
project.</p>
<div class="section" id="software-configuration-management">
<h3>Software Configuration Management<a class="headerlink" href="#software-configuration-management" title="Permalink to this headline">¶</a></h3>
<p>All software is managed through Git (Source Control Management) and
Github (Issue tracking, collaboration, etc.) in a publicly accessible
repository. Its location is currently at
<a class="reference external" href="https://github.com/ghachey/candy-basket/">https://github.com/ghachey/candy-basket/</a> but it will likely
eventually change to the owning organization Nasara. Until then you
can retrieve your own full local clone of the project with Git
installed on your machine:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ git clone git@github.com:ghachey/candy-basket.git
</pre></div>
</div>
<p>However, never publish work to master (at least as rarely as
possible). The following section describes the procedures to develop
on CB.</p>
</div>
<div class="section" id="on-going-development">
<h3>On-going Development<a class="headerlink" href="#on-going-development" title="Permalink to this headline">¶</a></h3>
<p>New development work on a software project is either of maintenance
(fixing bugs, addressing security issues) or construction nature
(adding new features). Regardless of the type of work, all new work
should be done in a branch, not on master. For example, let&#8217;s say
we&#8217;re tackling issue #3 from the issue tracking system (Trac, Github
Issues, etc.) you should <a class="reference external" href="http://www.git-scm.com/book/en/Git-Branching-Basic-Branching-and-Merging">create a branch</a>
like this <a class="reference internal" href="#pro-git" id="id3">[PRO-GIT]</a>:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ git checkout -b issue3
</pre></div>
</div>
<p>Work on the issue, add relevant tests so it does not occur again, all
the while only committing locally on your branch. Discuss with team
members the fix if not sure about something. Get team members to
review and refactor code if needed. After all this is done you can go
ahead with publishing your new fix following our defined standard
procedure.</p>
<p>It is desirable to keep the history of master&#8217;s commits as clean as
possible for more effective code review. The established way of
achieving this is to squash all your local commits from your <em>issue3</em>
branch into a single properly formatted commit before publishing
changes and doing a pull request to master.</p>
<p><a class="reference external" href="http://www.git-scm.com/book/en/Git-Tools-Rewriting-History#Squashing-Commits">Squashing commits</a>
in git is straight forward <a class="reference internal" href="#pro-git" id="id4">[PRO-GIT]</a>. However, the consolidated
commit must follow the following conventions adapted from <a class="reference external" href="https://docs.google.com/document/d/1QrDFcIiPjSLDn3EL15IJygNPiHORgU1_OOAqWjiDU5Y/edit#">Google
project AngularJS</a>
which will greatly enhanced the historical information on master and
allow for automatic generation of the changelog. The format of the
commit message must follow the following convention:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;
&lt;BLANK LINE&gt;
&lt;body&gt;
&lt;BLANK LINE&gt;
&lt;footer&gt;
</pre></div>
</div>
<p>Any line of the commit message must not be longer than 100
characters. This allows the message to be easier to read on github as
well as in various git tools.</p>
<p><strong>&lt;type&gt;</strong></p>
<p>Should be either of the following:</p>
<ul class="simple">
<li>feat (when working on new feature)</li>
<li>fix (when fixing a bug or addressing a security vulnerability)</li>
<li>docs (when working on documentation)</li>
<li>style (improving formatting, missing semi colons, indentation, etc.)</li>
<li>refactor (when doing minor or major refactoring work)</li>
<li>test (when adding missing tests)</li>
<li>chore (maintain)</li>
</ul>
<p><strong>&lt;scope&gt;</strong></p>
<p>Should specify the location of the commit as succinctly and completely
as possible (e.g. $location, $rootScope, ngHref, ngClick, ngView)</p>
<p><strong>&lt;subject&gt;</strong></p>
<p>Subject line contains succinct description of the change. Remember it
must not be longer than 100 characters and this <em>includes</em> both the
&lt;type&gt;(&lt;scope&gt;) identified before. Here are some convensions:</p>
<ul class="simple">
<li>use imperative, present tense: &#8220;change&#8221; not “changed” nor “changes”</li>
<li>don&#8217;t capitalize first letter</li>
<li>no period full stop (.) at the end</li>
</ul>
<p><strong>&lt;body&gt;</strong></p>
<p>[Optional] Slightly more elaborated description possibly spanning over several
lines never more than 100 characters each.</p>
<ul class="simple">
<li>just as in &lt;subject&gt; use imperative, present tense</li>
<li>includes motivation for the change and contrasts with previous behavior</li>
</ul>
<p><strong>&lt;footer&gt;</strong>:</p>
<p>[Optional] should include either breaking changes and/or references of
what issues were resolved if any. All breaking changes have to be
mentioned in footer with the description of the change, justification
and migration notes.</p>
<p>The following includes several examples of properly formatted squashed
commit messages.</p>
<p>A new feature commit:</p>
<div class="highlight-python"><div class="highlight"><pre>feat($browser): onUrlChange event (popstate/hashchange/polling)

Added new event to $browser:
* forward popstate event if available
* forward hashchange event if popstate not available
* do polling when neither popstate nor hashchange available

Breaks $browser.onHashChange, which was removed (use onUrlChange instead)
</pre></div>
</div>
<p>A fix for browser compatibility commit:</p>
<div class="highlight-python"><div class="highlight"><pre>fix($compile): couple of unit tests for IE9

Older IEs serialize html uppercased, but IE9 does not...
Would be better to expect case insensitive, unfortunately jasmine does
not allow to user regexps for throw expectations.

Closes #392
Breaks foo.bar api, foo.baz should be used instead
</pre></div>
</div>
<p>A new feature request from issue #351 commit:</p>
<div class="highlight-python"><div class="highlight"><pre>feat(directive): ng:disabled, ng:checked, ng:multiple, ng:readonly, ng:selected

New directives for proper binding these attributes in older browsers (IE).
Added coresponding description, live examples and e2e tests.

Closes #351, #456
</pre></div>
</div>
<p>Some cleanup commit:</p>
<div class="highlight-python"><div class="highlight"><pre>style($location): add couple of missing semi colons
</pre></div>
</div>
<p>Some documentation work commit:</p>
<div class="highlight-python"><div class="highlight"><pre>docs(guide): updated fixed docs from Google Docs

Couple of typos fixed:
* indentation
* batchLogbatchLog -&gt; batchLog
* start periodic checking
* missing brace
</pre></div>
</div>
<p>A new feature with major breaking changes:</p>
<div class="highlight-python"><div class="highlight"><pre>feat($compile): simplify isolate scope bindings

Changed the isolate scope binding options to:
* @attr - attribute binding (including interpolation)
* =model - by-directional model binding
* &amp;expr - expression execution binding

This change simplifies the terminology as well as
number of choices available to the developer. It
also supports local name aliasing from the parent.

BREAKING CHANGE: isolate scope bindings definition has changed and
the inject option for the directive controller injection was removed.

To migrate the code follow the example below:

Before:

scope: {
  myAttr: &#39;attribute&#39;,
  myBind: &#39;bind&#39;,
  myExpression: &#39;expression&#39;,
  myEval: &#39;evaluate&#39;,
  myAccessor: &#39;accessor&#39;
}

After:

scope: {
  myAttr: &#39;@&#39;,
  myBind: &#39;@&#39;,
  myExpression: &#39;&amp;&#39;,
  // myEval - usually not useful, but in cases where the
  // expression is assignable, you can use &#39;=&#39;
  myAccessor: &#39;=&#39; // in directive&#39;s template change myAccessor() to myAccessor
}

The removed `inject` wasn&#39;t generaly useful for directives so there should be no code using it.
</pre></div>
</div>
<p>For example, you&#8217;ve been working on your branch and made three commit
with vague non-useful messages such as &#8220;Work in progress&#8221;, &#8220;Small
fix&#8221;, etc. You want to wrap up the work with a nice single squashed
commit following the above format. You can use Git&#8217;s rebase tool:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ git rebase -i HEAD~3
</pre></div>
</div>
<p>This will pull open an editor with something like the following:</p>
<div class="highlight-python"><div class="highlight"><pre>pick f7f3f6d Work on docs
pick 310154e Work in progress
pick a5f4a0d Small fix

# Rebase 710f0f8..a5f4a0d onto 710f0f8
#
# Commands:
#  p, pick = use commit
#  r, reword = use commit, but edit the commit message
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#  f, fixup = like &quot;squash&quot;, but discard this commit&#39;s log message
#  x, exec = run command (the rest of the line) using shell
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out
</pre></div>
</div>
<p>To squash the three commits into one you would edit the script to look
like this:</p>
<div class="highlight-python"><div class="highlight"><pre>pick f7f3f6d Work on docs
squash 310154e Work in progress
squash a5f4a0d Small fix

# Rebase 710f0f8..a5f4a0d onto 710f0f8
#
# Commands:
#  p, pick = use commit
#  r, reword = use commit, but edit the commit message
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#  f, fixup = like &quot;squash&quot;, but discard this commit&#39;s log message
#  x, exec = run command (the rest of the line) using shell
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out
</pre></div>
</div>
<p>When saving this you will return to a text editor where you can merge
the commit messages seeying something like this</p>
<div class="highlight-python"><div class="highlight"><pre># This is a combination of 3 commits.
# The first commit&#39;s message is:
Work on docs

# This is the 2nd commit message:

Work in progress

# This is the 3rd commit message:

Small fix
</pre></div>
</div>
<p>Those commits are practically useless in the grand scheme of
things. You want to replace it with a single properly formatted
message following above conventions. In this case you would remove the
above from the text editor and replace it with something like the
following:</p>
<div class="highlight-python"><div class="highlight"><pre>docs(developer-guide.rst): update docs with new code base refactory

What&#39;s changed in details:
* Change backend section to reflect migration to NodeJS
* Refactor various part of guide with new content
* Introduce new conventions and standards
</pre></div>
</div>
<p>Save this nicely formatted commit and then you&#8217;re ready to publish
your work and do a pull request:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ git push
</pre></div>
</div>
<p>Do the pull request from github and use the last commit as the message.</p>
</div>
</div>
<div class="section" id="high-level-architecture">
<h2>High Level Architecture<a class="headerlink" href="#high-level-architecture" title="Permalink to this headline">¶</a></h2>
<p>Briefly, this application is composed of two main parts: a computer
consumable service on the backend (i.e. runs on the server) and a
human consumable service on the frontend (i.e. runs in the
browser). The backend is a NodeJS powered RESTful service and the
frontend is an HTML, CSS and Javascript Web User Interface (UI)
capable of talking to the backend.</p>
<ul class="simple">
<li>README.md &#8211; A brief introduction and pointers</li>
<li>LICENSE.md &#8211; GNU General Public License version 3</li>
<li>CHANGELOG.md &#8211; Automatically generated change logs</li>
<li>backend &#8211; The NodeJS RESTful service</li>
<li>frontend &#8211; The AngularJS Web application</li>
<li>docs &#8211; The documentation for this project</li>
<li>package.json &#8211; Root meta data JSON file</li>
<li>Gruntfile.js &#8211; Grunt task automation file common to backend and frontend</li>
</ul>
<div class="section" id="backend-the-restful-service">
<h3>Backend &#8211; The RESTful Service<a class="headerlink" href="#backend-the-restful-service" title="Permalink to this headline">¶</a></h3>
<p>The backend is written entirely in the Javascript programming language
implementing a simple RESTful service. The backend is a RESTful
service following a Resource Oriented Architecture (ROA) as defined in
<a class="reference internal" href="#rest-serv" id="id5">[REST-SERV]</a>. The following tables describe its service. Note that no
API version number is included in the URI; it will be included in the
host as <a class="reference external" href="http://candy-restapi-v1.pacificpolicy.org.vu/">http://candy-restapi-v1.pacificpolicy.org.vu/</a>.</p>
<div class="section" id="user-account-service">
<h4>User Account Service<a class="headerlink" href="#user-account-service" title="Permalink to this headline">¶</a></h4>
<p>Each organisation can have a number of users using the tool. However,
user management is usually done using an external service such as
Active Directory or another LDAP service like OpenLDAP. Candies do not
yet have ownership and are globally accessible by the organisation
once authenticated.</p>
<p>The URI design goes like this. A &#8220;basket&#8221; refers to the whole
organisation. In other words, organisations have their private basket
of candies. An organisation (and therefore a basket) can have many
users; the organization and its users can be represented as
/basket/users/, but this will not be used at first. All candies are
associated to a user and are (at least at first) accessible to any
authenticated staff.</p>
<p>The services offer no CRUD operations on users at the moment as this
is considered to be done using an external service (Active Directory,
OpenLDAP).</p>
</div>
<div class="section" id="source-candies-service">
<h4>Source (Candies) Service<a class="headerlink" href="#source-candies-service" title="Permalink to this headline">¶</a></h4>
<p>This is the main service of candy basket: users can add &#8220;source(s)&#8221;
and tag them. A source can have a URL, file(s), title description and
tags. In the technical world of Candy Basket (such as in the source
code) sources are typically referred to as candies; they are exactly
the same thing. In the UI the term source is used.</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">HTTP Method and URI</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Create a source</td>
<td>POST /basket/candies</td>
</tr>
<tr class="row-odd"><td>View a source</td>
<td>GET /basket/candies/{uuid}</td>
</tr>
<tr class="row-even"><td>Modify a source</td>
<td>PUT /basket/candies/{uuid}</td>
</tr>
<tr class="row-odd"><td>Delete a source</td>
<td>DELETE /basket/candies/{uuid}</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="utilities-service">
<h4>Utilities Service<a class="headerlink" href="#utilities-service" title="Permalink to this headline">¶</a></h4>
<p>Only a couple of utility aggregates are needed at the moment.</p>
<table border="1" class="docutils">
<colgroup>
<col width="46%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">HTTP Method and URI</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Fetch all sources</td>
<td>GET /basket/candies</td>
</tr>
<tr class="row-odd"><td>Fetch all tags</td>
<td>GET /basket/candies/tags</td>
</tr>
<tr class="row-even"><td>Fetch all tags by candies</td>
<td>GET /basket/candies/tags-by-candies</td>
</tr>
</tbody>
</table>
<p>When developing it is often useful to use the RESTful API
directly. Here are some example usage.</p>
<p>Fetching all candies:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ curl --user candy:P@55word -X GET http://localhost:3003/basket/candies
</pre></div>
</div>
<p>Fetching a candy:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ curl --user candy:P@55word -X GET http://localhost:3003/basket/candies/03c0b670e5c56bfb461a76dcf7000d1c
</pre></div>
</div>
<p>Creating a candy:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ curl --user candy:P@55word
             -X POST \
             -H &quot;Accept: application/json&quot;  \
             -H &quot;Content-Type: application/json&quot; \
             -d @candy.json \
             http://localhost:3003/basket/candies
</pre></div>
</div>
<p>Where candy.json would be the JSON candy in a file named candy.json
accessible within the directory from which curl command is being
executed. Routes only accept JSON at the moment.  It could look
something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;source&quot;</span><span class="p">:</span> <span class="s">&quot;http://www.ghachey.info&quot;</span><span class="p">,</span>
  <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Ghislain Hachey Website&quot;</span><span class="p">,</span>
  <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;A bit updated&quot;</span><span class="p">,</span>
  <span class="s">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;gh&quot;</span><span class="p">,</span><span class="s">&quot;ict&quot;</span><span class="p">,</span><span class="s">&quot;website&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or an invalid candy (dangeous scripts):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;source&quot;</span><span class="p">:</span> <span class="s">&quot;http://www.ghachey.info&quot;</span><span class="p">,</span>
  <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Ghislain Website&quot;</span><span class="p">,</span>
  <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;&lt;script&gt;alert(</span><span class="se">\&quot;</span><span class="s">Hacked onced, shame on you.</span><span class="se">\&quot;</span><span class="s">);&lt;/script&gt;&quot;</span><span class="p">,</span>
  <span class="s">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s">&quot;Website&quot;</span><span class="p">,</span>
    <span class="s">&quot;Ghislain Hachey&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you want to test uploading the easiest is to use the frontend
directly. Otherwise, you could build a request yourself with curl by
setting the <cite>Content-Type</cite> to <cite>multipart/form-data</cite> and the additional
JSON data which would be something like this:</p>
<div class="highlight-python"><div class="highlight"><pre>&quot;files&quot;:[{&quot;name&quot;:&quot;0bf6198aac462ddbb12add63fff0d8c2.pdf&quot;,
          &quot;originalName&quot;:&quot;Artificial Intelligence Search Algorithms.pdf&quot;},
         {&quot;name&quot;:&quot;7fde008c066d3ed6226d5a88b2f1e7ef.png&quot;,
          &quot;originalName&quot;:&quot;linkedin.png&quot;}]
</pre></div>
</div>
<p>Where the name is a UUID generated by the frontend upload code and the
original name is also kept. The file would be sent to the ownCloud
with the unique name but could be listed and retrived using the
original name.</p>
<p>Updating a candy:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ curl --user candy:P@55word
             -X PUT \
             -H &quot;Accept: application/json&quot;  \
             -H &quot;Content-Type: application/json&quot; \
             -d @candy-update.json \
             http://localhost:3003/basket/candies/id-of-candy-in-couchdb
</pre></div>
</div>
<p>Where id-of-candy-in-couchdb is the id automatically created on POST
and returned in the Location header for latter retrieval. It can be
retrieved in a number of ways. Looking at data in the DB is fairly
easy and quick. The newly updated candy could look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;_id&quot;: &quot;id-of-candy-in-couchdb&quot;
  &quot;source&quot;: &quot;http://www.ghachey.info&quot;,
  &quot;title&quot;: &quot;Ghislain Hachey Website&quot;,
  &quot;description&quot;: &quot;A bit updated--oups, I meant a bit outdated&quot;,
  &quot;tags&quot;: [&quot;gh&quot;,&quot;ict&quot;,&quot;website&quot;]
}
</pre></div>
</div>
<p>This would completely replace the previous document. For example, if
you had a <cite>files</cite> data in the JSON document and none in the update
then that data would no longer be present. A complete update on a
document containing also files could be achieved with a minimum couple
of async curl requests. First the file upload(s):</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ curl --user candy:P@55word
             -X POST \
             -H &quot;Content-Type: multipart/form-data; boundary=---------------------------11936647625814307171179269292&quot; \
             --data-binary @test.txt \
             http://localhost:3003/files
</pre></div>
</div>
<p>And then the actual candy:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ curl --user candy:P@55word
             -X PUT \
             -H &quot;Accept: application/json&quot;  \
             -H &quot;Content-Type: application/json&quot; \
             -d @candy-update.json \
             http://localhost:3003/basket/candies/id-of-candy-in-couchdb
</pre></div>
</div>
</div>
</div>
<div class="section" id="frontend-web-ui-application">
<h3>Frontend &#8211; Web UI Application<a class="headerlink" href="#frontend-web-ui-application" title="Permalink to this headline">¶</a></h3>
<p>The Frontend is developed using the AngularJS web framework with
community Angular modules and our own code. The frontend code based is
organised following Angular community best practices.</p>
<ul class="simple">
<li><cite>frontend/app/scripts/app.js</cite>: this is where the application is
bootstrapped. It contains some configuration and some routes
definitions.</li>
<li><cite>frontend/app/scripts/services/</cite>: this directory contains
application services.</li>
<li><cite>frontend/app/scripts/controllers/</cite>: this is where the business
logic resides; no DOM manipulation should happen here.</li>
<li><cite>frontend/app/scripts/filters/</cite>: this where filters are stored often
used has a final filtering step before presenting the data
(e.g. money and date conversions formatters). It can also include
data filtering code.</li>
<li><cite>frontend/app/scripts/directives/</cite>: this is where you can manipulate
the DOM as you wish. Think of directives as a means to extend HTML
and browser capabilities for web <em>applications</em>.</li>
<li><cite>frontend/app/index.html</cite>: is the base HTML file for the whole
application</li>
<li><cite>frontend/app/views/</cite>: contains all the other HTML partials that
make up the rest of the application.</li>
<li><cite>frontend/app/styles/</cite>: contains custom styles</li>
<li><cite>frontend/app/images/</cite>: contains images</li>
<li><cite>frontend/test/specs/</cite>: where unit tests resides. Directories in there
mirrors the content of the <cite>frontend/app/scripts/</cite></li>
</ul>
</div>
</div>
<div class="section" id="low-level-documentation-and-api">
<h2>Low Level Documentation and API<a class="headerlink" href="#low-level-documentation-and-api" title="Permalink to this headline">¶</a></h2>
<p>The lower level documentation about software design, application
programming interfaces, small gotchas and all other nitty-gritty
details about the source code is written directly inside the source
code. It can be extracted and exported to hard copy formats such as
HTML or PDF and eventually may be integrated with this documentation
also.</p>
</div>
<div class="section" id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>Documentation is currently prepared using two different tools which is
not ideal but powerful and convenient for the time being. As this
project progresses we&#8217;ll look into more cleanly unify this if possible
without too much investment.</p>
<p>Most documentation is prepared using an excellent tool developed in
the Python world called Sphinx <a class="reference external" href="http://sphinx-doc.org">http://sphinx-doc.org</a> which uses the reStructuredText markup
language <a class="reference external" href="http://sphinx-doc.org/rest.html">http://sphinx-doc.org/rest.html</a>. Sphinx outputs to HTML and PDF
but could also output to other formats.</p>
<p>In the docs folder there is a <tt class="docutils literal"><span class="pre">source</span></tt> directory which contains the
source files with the markup content; this is where the documentation
is written. The <tt class="docutils literal"><span class="pre">build</span></tt> directory is where the documentation is
produced either in PDF, HTML or other supported format.</p>
<p>If you plan on producing documentation you will need to install
Sphinx. Sphinx is written in <a class="reference external" href="https://www.python.org/">Python</a> can
the easiest way to install it is to install Python and <a class="reference external" href="https://github.com/pypa/pip">pip</a> and then execute the following to
install globally:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ sudo pip install sphinx
</pre></div>
</div>
<p>Outputs are generated using a simple make command from within the
<tt class="docutils literal"><span class="pre">docs</span></tt> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ make latexpdf
[user]$ make html
</pre></div>
</div>
<p>Or simply type <tt class="docutils literal"><span class="pre">make</span></tt> to get a list of other options. If you wish
you generate PDF you will need to install the Tex type setting system
along with LaTeX, but this is optional. How to do this will largely
depend on your OS. There is usually a very large all in one package
available for popular OSes either packaged as binary or directly
available through the OS&#8217; package manager.</p>
<p>All source code including the application programming interface is
documented in a modern Javascript fashion using a jsdoc style with
AngularJS additional conventions. This has a number of advantages
including keeping the documentation directly with the code and more in
sync, preparation of AngularJS style documentation with the ability to
add example usage, online discussions and a number of others things
not readibly available when simply using Sphinx. When writting source
code simply document it following <a class="reference external" href="https://github.com/angular/angular.js">AngularJS</a> and <a class="reference external" href="http://usejsdoc.org/">jsdoc</a> styles and the production of the online
documentation is easy with grunt. From with the candy-basket directory
simply run:</p>
<div class="highlight-python"><div class="highlight"><pre>[user]$ grunt docs
</pre></div>
</div>
</div>
<div class="section" id="security-considerations">
<h2>Security Considerations<a class="headerlink" href="#security-considerations" title="Permalink to this headline">¶</a></h2>
<p>Since Candy Basket will be used as a tool by organizations with
varying degrees of security requirements it must be designed and
evolve with a number of security considerations in mind and the aim of
constantly improving its security status quo.</p>
<p>If you are interested in helping contribute code to Candy Basket we
provide some mininum security related recommendations, guidelines and
procedures to follow.</p>
<div class="section" id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h3>
<p>The backend currently supports only HTTP Basic Authentication on every
single endpoint. It is critical to properly setup SSL/TLS to encrypt
all communication between the client (frontend) and the server
(backend). It makes use of a single user called <cite>candy</cite> to
authenticate the frontend with the backend which is configurable in
<cite>backend/config.js</cite>. Therefore, users authenticated to the frontend
through some LDAP single sign-on mechanism will then automatically
have access to data from backend. In other words, no access to
frontend, no access to backend either.</p>
</div>
<div class="section" id="ssl-tls-encryption">
<h3>SSL/TLS Encryption<a class="headerlink" href="#ssl-tls-encryption" title="Permalink to this headline">¶</a></h3>
<p>This application is moving towards a strict and mandatory use of
encryption throughout all its the various components .  Self-signed
keys and certificates are used for development and test and the
equivalent of curl&#8217;s &#8211;insecure flag is set when executing requests in
those modes. This insecure flag is off by default in production.</p>
<div class="section" id="owncloud">
<h4>ownCloud<a class="headerlink" href="#owncloud" title="Permalink to this headline">¶</a></h4>
<p>Candy Basket uses ownCloud as file storage. Connections to ownCloud
must be encrypted. Developers can use their own local ownCloud server
for development and test though will have to include their own
certificate in the <cite>backend/certificates</cite> directory and change the
config.js. The certificate to make use of the pacificpolicy.org
ownCloud server is also included. Casre must be taken with the
configuration of the ownCloud server to enforce secure connections at
all times.</p>
</div>
<div class="section" id="nasara-backend">
<h4>Nasara backend<a class="headerlink" href="#nasara-backend" title="Permalink to this headline">¶</a></h4>
<p>The backend now also supports encryption. In fact, it only listens on
https, period (port 3003 for test and development and 443 for
production). A set of development keys was generated which can be use
for just development and test without change in the
<cite>backend/config.js</cite>. Both the private key and public certificate are
committed to the repo for development and test convenience. Needless
to say they should not be used in production. A new set should be
used, either self signed or both from a CA depending on the context
and target users.</p>
</div>
<div class="section" id="nasara-frontend">
<h4>Nasara frontend<a class="headerlink" href="#nasara-frontend" title="Permalink to this headline">¶</a></h4>
<p>To access the backend with the self-signed certificate in development
from AngularJS the browser needs to confirm the insecure connection
(like curl&#8217;s &#8211;insecure or NodeJS&#8217;s
process.env.NODE_TLS_REJECT_UNAUTHORIZED = &#8216;0&#8217;). Only once you will
have to point the browser directly to the backend by putting the
address <cite>https://localhost:3003/</cite> in the URL address bar.</p>
</div>
</div>
<div class="section" id="latest-top-10-security-risks">
<h3>Latest Top 10 Security Risks<a class="headerlink" href="#latest-top-10-security-risks" title="Permalink to this headline">¶</a></h3>
<p>An initial security assessment determined that this application was
designed with all the security basics in mind although tighthening
security should always remains an objectif as he project
evolves. Candy Basket was measured against OWASP&#8217;s most up-to-date
<a class="reference external" href="https://owasp.org/index.php/Top_10_2013-Table_of_Contents">Top 10 Security Risks</a>. It is
important to re-assess Candy Basket towards this top 10 list every
year (or whenever it is revised). Any change should be carefully
examine to make sure Candy Basket still covers all of them
with details reflected in this documentation.</p>
<div class="section" id="injection">
<h4>Injection<a class="headerlink" href="#injection" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A1-Injection">A1 &#8211; Injection</a>. Candy Basket
makes all necessary efforts to validate data both in the frontend and
the backend to prevent any injection through its communication with
its data store.</p>
<p>Automated scanners can do a good job but should be combined with
manual code review for completeness.</p>
</div>
<div class="section" id="broken-authentication-and-session-management">
<h4>Broken Authentication and Session Management<a class="headerlink" href="#broken-authentication-and-session-management" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A2-Broken_Authentication_and_Session_Management">A2 &#8211; Broken Authentication and
Session Management</a>. All
authentication and session management of the application
(i.e. frontend) is left at the Active Directory level through Kerberos
and Apache. This setup should be verified at each upgrade to make sure
it is updated and working as expected. Also make sure that only the
frontend can communicate with the backend at the web server
configuration level.</p>
<p>Strict adherence to recommendations in <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A2-Broken_Authentication_and_Session_Management">A2 &#8211; Broken Authentication
and Session Management</a>
is a good start. Anybody working on Candy Basket should have in their
possession the VMware network lab: a Windows 2008 Server (AD, DNS...),
A Debian server (Apache, Kerberos to host Candy Basket ), a Windows 7
workstation, a Windows 8 workstation, any other network node useful in
testing authentication and sessions.</p>
</div>
<div class="section" id="xss">
<h4>XSS<a class="headerlink" href="#xss" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A3-Cross-Site_Scripting_(XSS)">A3 &#8211; Cross-Site Scripting (XSS)</a>. Candy
Basket covers this one much like protecting agains injections:
frontend and backend data validation, automatic sanitization of rich
content, and appropriate escaping of untrusted data.</p>
<p>A mix of automated tools and manual code review can be employed for
Integrated Penetration Testing.</p>
</div>
<div class="section" id="security-misconfiguration">
<h4>Security Misconfiguration<a class="headerlink" href="#security-misconfiguration" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A5-Security_Misconfiguration">A5 &#8211; Security Misconfiguration</a>. There
is a lot to keep track of here: OS configuration, Web server and
modules configuration, Candy Basket application configuration, third
party libraries default security related configuration. A simple
change to the Candy Basket code base making use of the configuration
variables could open up an easy security hole. For example, in DEBUG
mode the application accepts a non existant Origin header to make
testing of backend with curl straight forward. If this were left
unchanged in production an attacker could execute cross-domain
requests simply by removing the Origin completely in its
reponses. It&#8217;s all too easy to write a single line of code that can
result in this; I wrote one myself and left it there for about 15
minutes until I realised the consequence.</p>
<p>Regular overview of all the configuration from low to high level
should be integrated into the develop, test and deploy cycle. A grep
on DEBUG on the whole Candy Basket code base might help in identifying
unsafe code. The use of scanners on the OS and Web server
(e.g. Nessus) can be useful. The important thing is the have solid and
fast development operations in place with the ability to deploy in new
secure environments that can be quality tested in quick cycles.</p>
</div>
<div class="section" id="sensitive-data-exposure">
<h4>Sensitive Data Exposure<a class="headerlink" href="#sensitive-data-exposure" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A6-Sensitive_Data_Exposure">A6 &#8211; Sensitive Data Exposure</a>. Most
sensitive user data is handled at the Active Directory level. Securing
this aspect means keeping the Windows (or Samba4) server updated and
properly configured. The information in the database (aka. the
candies) can often also be considered sensitive information and is
secured through a combination of all the security mechanisms in
place. Otherwise, data can be accessed in a number of ways:</p>
<div class="highlight-python"><div class="highlight"><pre>* CouchDB only listens on the local interface but this could further
</pre></div>
</div>
<blockquote>
<div>be tightened.</div></blockquote>
<ul class="simple">
<li>The backend has access to the data so should be secure. At the
moment, its access is restricted to the frontend through Apache directives.</li>
<li>The frontend can access data through the backend but the user must
be authenticated with an Active Diretory to access the frontend.</li>
</ul>
</div>
<div class="section" id="missing-function-level-access-control">
<h4>Missing Function Level Access Control<a class="headerlink" href="#missing-function-level-access-control" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A7-Missing_Function_Level_Access_Control">A7 &#8211; Missing Function Level
Access Control</a>. Candy
Basket does not do much in terms of Access Control. Either the user
has access to the application or not. This significantly reduces the
complexity and therefore the attack vectors.</p>
<p>Make sure all other risks are properly addressed and this one should
be covered.</p>
</div>
<div class="section" id="cross-site-request-forgery-csrf-aka-xsrf">
<h4>Cross-Site Request Forgery (CSRF aka. XSRF)<a class="headerlink" href="#cross-site-request-forgery-csrf-aka-xsrf" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A8-Cross-Site_Request_Forgery_%28CSRF%29">A8 &#8211; Cross-Site Request Forgery
(CSRF aka. XSRF)</a>.
A number of mechanisms exist with varying degrees of strength to
protect against CSRF. The present status quo with Candy Basket can
best be explained by summarising an email dialogue between Dan McGarry
and Ghislain Hachey:</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; It is possible to protect against CSRF by checking the origin header,
&gt; but since this could be spoofed it would only be a first line of
&gt; defence. From my understanding, the highest form of security against CSRF
&gt; is making use of secret tokens first generated by the server and sent
&gt; on each request from the application (which is the number one
&gt; recommendation of OWASP. However,
&gt; according to Angular developers the above scenario is typical of
&gt; non-CORS applications where cookie-based authentication is used
&gt; (i.e. cases most vulnerable to CSRF attacks).  We have a different use
&gt; case: one, we are CORS enabled (`http://www.mnemonic.com` talking to
&gt; `http://rest.mnemonic.com`); two, we do not make use of cookie-based
&gt; authentication but make use of authentication at the Apache level
&gt; using kerberos and AD. While CORS alone is not a protection against
&gt; CRSF, the first line of defence herein (i.e. checking origin) would
&gt; make it quite hard for an attacker who would have to *both* spoof the
&gt; origin *and* trick the user into clicking a malicious page executing
&gt; it when logged into AD at work or on a VPN.
&gt;
&gt; I looked into alternatives to further secure the CSRF weakness and
&gt; found out about the use of XSRF-TOKEN. In short, the server generates
&gt; a secret token which is passed to Angular on the first request as a
&gt; cookie which is then returned by Angular on each request in a header
&gt; (i.e. X-XSRF-TOKEN). Server then verifies header matches cookie on
&gt; each request and if so considers the user legitimate (since only
&gt; Javascript running in the user browser could know the original
&gt; token). However, according to angular this is typically a non-CORS use
&gt; case and Angular does not bother returning the token I created on the
&gt; server in the request header because we do cross-domain requests
&gt; making our use case a bit more painful when it comes to using this type
&gt; of protection. See
&gt; &lt;http://docs.angularjs.org/api/ng/service/$http&gt; and
&gt; &lt;https://github.com/angular/angular.js/issues/5122&gt;.
&gt;
&gt; My take on it is that we have a relatively non-typical use case:
&gt; de-coupled REST server with single page web application authenticating
&gt; with Apache/Kerberos/AD. I see two possible paths we could take:
&gt;
&gt; 1) To secure this to my taste I would make it &quot;impossible&quot; to talk to
&gt;    the REST server from anything but the frontend application
&gt;    (essentially what CORS aims except it does not offer protection
&gt;    against spoofing). At the moment, this is enforced at the web
&gt;    server level but does not protect against sophisticated
&gt;    spoofing. The angular application would make use of a user which
&gt;    would authenticate to the backend through robust use of token-based
&gt;    authentication. Token-based authentication has a number of
&gt;    advantages over the currently prevalent use of cookie-based
&gt;    authentication (good reads here
&gt;    &lt;http://www.jamesward.com/2013/05/13/securing-single-page-apps-and-rest-services&gt;,
&gt;    &lt;http://blog.auth0.com/2014/01/07/angularjs-authentication-with-cookies-vs-token/&gt;). Another
&gt;    advantage of doing this would be to take Candy Basket one step
&gt;    closer to a &quot;public offering&quot; and not just an &quot;enterprise
&gt;    offering&quot;.
&gt;
&gt; 2) Another more hackish method is to force Angular to send the
&gt;    XSRF-TOKEN by intercepting and adding headers on each XHR. However,
&gt;    the angular folks specifically deactivated this as they essentially
&gt;    say it should not be done like this and stated it was causing
&gt;    problems with the CORS pre-flights (CORS makes use of pre-flight
&gt;    OPTIONS requests to check whether non-safe requests such as POST,
&gt;    PUT and DELETE are allowed by the origin). This approach would
&gt;    secure the backend and frontend integration against spoofing but is
&gt;    not my preferred options.
</pre></div>
</div>
<p>In conclusion, Candy Basket&#8217;s current CSRF protection of checking the
Origin on the server side and only allowing the frontend access to the
backend seems adequate. Even if the attacker manages to spoof the
origin <em>and</em> trick the user into clicking a malicious link disguised as
cute kittens, the backend would refuse the request&#8212;even when the user
is authenticated&#8212;based on restrictions at the Apache level
(i.e. only the frontend application can talk to the backend).</p>
</div>
<div class="section" id="using-components-with-known-vulnerabilities">
<h4>Using Components with Known Vulnerabilities<a class="headerlink" href="#using-components-with-known-vulnerabilities" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A9-Using_Components_with_Known_Vulnerabilities">A9 &#8211; Using Components with Known
Vulnerabilities</a>.</p>
<p>Candy Baskets is based on a number of libraries each of which could
potentially have security vulnerabilities. While it is often
impractical to constantly assess all third party libraries it is easy
to subscribe to some kind of communication channels and observe the
evolution of all the components used in your software. Communication
channels could be either mailing lists, social networks or the github
issues tracker.</p>
<p>If there are discovered security vulnerabilities&#8212;those that are of
actual real life concern&#8212;they will often be announced through the
project&#8217;s communication channels. You should at the very least follow
announcements of the following projects:</p>
<ul class="simple">
<li>Angular (and all its modules which are usually upgraded in sync)</li>
<li>D3 and D3 Cloud</li>
<li>JQuery</li>
<li>MomentJS</li>
<li>UI Bootstrap</li>
<li>UndercoreJS</li>
<li>CouchDB</li>
<li>The hosting Platform (OS, Web server, Modules...)</li>
</ul>
<p>Whenever any of the above project announces a security vulnerability
there should be an upgrade in process. Typically, very little change
will be required, sometimes a simple matter of executing a <cite>bower
upgrade</cite> and a re-deploy. At times, you may be faced with breaking
changes which will require you to also upgrade the Candy Basket code.</p>
<p>All the above third libraries take security seriously. If you plan on
integrating a new library to add features to Candy Basket a good deal
of consideration must be given to the security aspect of the new
library. Adopting a project with little regard to security should be
<em>always</em> avoided.</p>
</div>
<div class="section" id="unvalidated-redirects-and-forwards">
<h4>Unvalidated Redirects and Forwards<a class="headerlink" href="#unvalidated-redirects-and-forwards" title="Permalink to this headline">¶</a></h4>
<p>General information can be found at <a class="reference external" href="https://owasp.org/index.php/Top_10_2013-A10-Unvalidated_Redirects_and_Forwards">A10 &#8211; Unvalidated Redirects and
Forwards</a>. Candy
Basket makes almost no use of redirects and forwards and no use of
dangerous redirects and forwards (using destination parameters based
on users or other dynamic variables).</p>
<p>Avoid using all but the most simple forwards and redirects. For
example, a redirect to the list view on save or cancel operation is
fine but avoid anything else for the moment. This will depend on the
future direction of Candy Basket.</p>
</div>
<div class="section" id="miscellaneous-and-application-specific">
<h4>Miscellaneous and Application Specific<a class="headerlink" href="#miscellaneous-and-application-specific" title="Permalink to this headline">¶</a></h4>
<p>There are a number of security considerations that were not part of
the top 10 list but that do apply to our specific use case. Those
should be documented here:</p>
<ul class="simple">
<li>We make use of JSON as the data interchange format. JSON contains a
<a class="reference external" href="http://haacked.com/archive/2008/11/20/anatomy-of-a-subtle-json-vulnerability.aspx">subtle vulnarability</a>
when returning data as an array. Angular offers a way to address
this issue by prefixing all JSON requests with the string &#8221;)]}&#8217;,n&#8221;
as described <a class="reference external" href="http://docs.angularjs.org/api/ng/service/$http">here</a>. We simple always
return an JSON object instead. For example, if we want to return an
array of Candies we would send something like {&#8220;data&#8221; : [&#8220;candy1&#8221;,
&#8220;candy2&#8221;...]} and transform the request in Angular to process the
array.</li>
</ul>
</div>
</div>
<div class="section" id="integrated-penetration-testing">
<h3>Integrated Penetration Testing<a class="headerlink" href="#integrated-penetration-testing" title="Permalink to this headline">¶</a></h3>
<p>The above guidelines and procedures should offer an excellent starting
point to ensure a secure web application. Of course, securing a web
application should not stop here. We would like to see a more
integrated penetration testing process. There are a number of tools
that can be used to help support this process. Most of those tools
have a relatelively steep learning curve but they are worth the time
investment.</p>
<p>After some time evaluating several free software tools that were
either recommended by OWASP or considered promising projects we have
come up with a short list of tools to watch:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">OWASP Zed Attack Proxy Project (ZAP)</a></li>
<li><a class="reference external" href="https://www.owasp.org/index.php/Category:OWASP_CSRFTester_Project">OWASP CSRFTester</a></li>
<li><a class="reference external" href="https://www.owasp.org/index.php/Category:OWASP_WebScarab_Project">OWASP WebScarab</a></li>
<li><a class="reference external" href="http://www.subgraph.com/">Vega</a> a fork of Google Researchers&#8217; Skipfish backed up by
commercial support. A younger but promising project which seem
easier to use at first glance.</li>
</ul>
<p>One or more of those tools should eventually be integrated into the
development process. At first only making use of simple features such
as automated scans and slowly integrating more complicated robust
testing processes one by one. As these new processes come to live they
should be clearly documented here with instructions on how to use the
tools.</p>
<table class="docutils citation" frame="void" id="rest-serv" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[REST-SERV]</a></td><td>Leonard Richardson and Sam Ruby, RESTful Web Services, O’Reilly, May 2007.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="fhs" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[FHS]</td><td>Rusty Russell, Daniel Quinlan and Christopher Yeoh, Filesystem Hierarchy Standard 2004, freestandards.org</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="pro-git" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[PRO-GIT]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id4">2</a>)</em> Scott Chacon, Pro Git,Available at <a class="reference external" href="http://www.git-scm.com/book">http://www.git-scm.com/book</a>,</td></tr>
</tbody>
</table>
<p>Apress.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Developer Guide</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#programming-language">Programming Language</a></li>
<li><a class="reference internal" href="#web-stack">Web Stack</a></li>
<li><a class="reference internal" href="#database">Database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-up-the-development-environment">Setting Up the Development Environment</a><ul>
<li><a class="reference internal" href="#development-tools">Development Tools</a></li>
<li><a class="reference internal" href="#nodejs-and-npm">NodeJS and NPM</a></li>
<li><a class="reference internal" href="#id1">CouchDB</a></li>
<li><a class="reference internal" href="#grunt">Grunt</a><ul>
<li><a class="reference internal" href="#grunt-on-the-backend">Grunt on the backend</a></li>
<li><a class="reference internal" href="#grunt-on-the-frontend">Grunt on the frontend</a></li>
<li><a class="reference internal" href="#grunt-globally-in-app-root">Grunt globally in app root</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#development-work-flow">Development Work-flow</a><ul>
<li><a class="reference internal" href="#software-configuration-management">Software Configuration Management</a></li>
<li><a class="reference internal" href="#on-going-development">On-going Development</a></li>
</ul>
</li>
<li><a class="reference internal" href="#high-level-architecture">High Level Architecture</a><ul>
<li><a class="reference internal" href="#backend-the-restful-service">Backend &#8211; The RESTful Service</a><ul>
<li><a class="reference internal" href="#user-account-service">User Account Service</a></li>
<li><a class="reference internal" href="#source-candies-service">Source (Candies) Service</a></li>
<li><a class="reference internal" href="#utilities-service">Utilities Service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#frontend-web-ui-application">Frontend &#8211; Web UI Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#low-level-documentation-and-api">Low Level Documentation and API</a></li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
<li><a class="reference internal" href="#security-considerations">Security Considerations</a><ul>
<li><a class="reference internal" href="#authentication">Authentication</a></li>
<li><a class="reference internal" href="#ssl-tls-encryption">SSL/TLS Encryption</a><ul>
<li><a class="reference internal" href="#owncloud">ownCloud</a></li>
<li><a class="reference internal" href="#nasara-backend">Nasara backend</a></li>
<li><a class="reference internal" href="#nasara-frontend">Nasara frontend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#latest-top-10-security-risks">Latest Top 10 Security Risks</a><ul>
<li><a class="reference internal" href="#injection">Injection</a></li>
<li><a class="reference internal" href="#broken-authentication-and-session-management">Broken Authentication and Session Management</a></li>
<li><a class="reference internal" href="#xss">XSS</a></li>
<li><a class="reference internal" href="#security-misconfiguration">Security Misconfiguration</a></li>
<li><a class="reference internal" href="#sensitive-data-exposure">Sensitive Data Exposure</a></li>
<li><a class="reference internal" href="#missing-function-level-access-control">Missing Function Level Access Control</a></li>
<li><a class="reference internal" href="#cross-site-request-forgery-csrf-aka-xsrf">Cross-Site Request Forgery (CSRF aka. XSRF)</a></li>
<li><a class="reference internal" href="#using-components-with-known-vulnerabilities">Using Components with Known Vulnerabilities</a></li>
<li><a class="reference internal" href="#unvalidated-redirects-and-forwards">Unvalidated Redirects and Forwards</a></li>
<li><a class="reference internal" href="#miscellaneous-and-application-specific">Miscellaneous and Application Specific</a></li>
</ul>
</li>
<li><a class="reference internal" href="#integrated-penetration-testing">Integrated Penetration Testing</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="administrator-guide.html"
                        title="previous chapter">Administrator Guide</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/developer-guide.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="administrator-guide.html" title="Administrator Guide"
             >previous</a> |</li>
        <li><a href="index.html">Candy Basket 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ghislain Hachey and Dan McGarry.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>